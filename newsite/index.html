<!doctype html>
<html>
    <head>
        <title>Telemetry</title>
        <link  href="http://code.jquery.com/ui/1.11.3/themes/smoothness/jquery-ui.css" rel="stylesheet" />
        <script src="/socket.io/socket.io.js"></script>
        <script src="/jquery-2.1.1.min.js"></script>
        <script src="http://code.jquery.com/ui/1.11.3/jquery-ui.js"></script>
        <script src="/highcharts.js"></script>
        <script src="/highcharts-more.js"></script>
        <script src="/underscore.js"></script>
        <style>
            * { margin: 0; padding: 0; box-sizing: border-box; }
            body { font: 13px Helvetica, Arial; width: 100%;}

            #plots {list-style-image: none; margin: 0; padding: 0; width: 100%;}
            #plots li { margin: 1px 1px 1px 0; padding: 0px; float: left; width: 49%; height: 270px; font-size: 2em; text-align: center; text-indent: center; }
        </style>
    </head>
    <body>
        <ul id="plots">
        <!-- All plots are dynamically created here as: -->
        <!-- <li class="ui-state-default" id="sensor-name"></li> -->
        </ul>

        <script>
            'use strict';
            function pad(width, string, padding) {
                  return (width <= string.length) ? string : pad(width, padding + string, padding);
            }

            function escapeNonWords(s) {
                return s.replace(/[_\W]+/g, "-");
            }

            var socket = io();
            var plots = {}; // Map of sensor -> chart

            socket.on('data', function(pkt){
                if (pkt.name in plots) {
                    // Update the plot
                    var shift = plots[pkt.name].series[0].data.length > 20;
                    plots[pkt.name].series[0].addPoint(pkt.value, true, shift);
                } else {
                    // Element does not exists, create it
                    $('#plots').append('<li class="ui-state-default" id="' + escapeNonWords(pkt.name) + '">');
                    plots[pkt.name] = new Highcharts.Chart({
                        chart: {
                            renderTo: escapeNonWords(pkt.name),
                            defaultSeriesType: 'spline',
                            valueDecimals: 2,
                            animation: false,
                        },
                        title: {
                            text: _.escape(pkt.name),
                        },
                        xAxis: {
                            labels: {
                                format: '{value:.2f}',
                            },
                        },
                        yAxis: {
                            title: {
                                text: 'Value',
                            },
                            labels: {
                                format: '{value:.2f}'
                            },
                        },
                        plotOptions: {
                            series: {
                                enableMouseTracking: true,
                                allowPointSelect: false,
                            },
                        },
                        series: [{
                            name: _.escape(pkt.name),
                            data: [pkt.value],
                        }],
                    });
                }
                $(function() {
                    $("#plots").sortable();
                    $("#plots").disableSelection();
                });
            });
        </script>
    </body>
</html>
