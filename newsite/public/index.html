<!DOCTYPE html>
<html>
    <head>
        <title>Telemetry</title>
        <!-- <link  href="http://code.jquery.com/ui/1.11.3/themes/smoothness/jquery-ui.css" rel="stylesheet" /> -->
        <link href="/css/vendor/jquery-ui.css" rel="stylesheet" />
        <link rel="stylesheet" type="text/css" href="style.css">

        <script src="/socket.io/socket.io.js"></script>
        <script src="/js/vendor/jquery-2.1.1.min.js"></script>
        <!-- <script src="http://code.jquery.com/ui/1.11.3/jquery-ui.js"></script> -->
        <script src="/js/vendor/jquery-ui.js"></script>
        <script src="/js/vendor/highcharts.js"></script>
        <script src="/js/vendor/highcharts-more.js"></script>
        <script src="/js/vendor/underscore.js"></script>
    </head>
    <body>
        <header>
            <h1>AAU Racing Telemetry</h1>
        </header>

        <div class = "left">        
            <ul id="rawlist">
            <!-- All plots are dynamically listed here -->
            <!-- <li class="ui-state-default" id="sensor-name"></li> -->
            </ul>
        </div>

        <div class = "content">        
            <ul id="plots">
            <!-- All plots are dynamically created here as: -->
            <!-- <li class="ui-state-default" id="sensor-name"></li> -->
            </ul>
        </div>

        <script>
            'use strict';

            function escapeNonWords(s) {
                return s.replace(/[_\W]+/g, "-");
            }

            var socket = io();
            var plots = {}; // Map of sensor -> chart

            socket.on('data', function(pkt){
                if (pkt.name in plots) {
                    // Update the plot
                    var shift = plots[pkt.name].series[0].data.length > 50;
                    plots[pkt.name].series[0].addPoint(pkt.value, true, shift);
                } else {
                    // Element does not exists, create it
                    $('#plots').append('<li class="ui-state-default" id="' + escapeNonWords(pkt.name) + '">');
                    $('#rawlist').append('<li><input type="checkbox" class="ui-state-default" id="' + escapeNonWords(pkt.name) + '"><label for="' + escapeNonWords(pkt.name) + '">' + _.escape(pkt.name) + '</label><li>');
                    plots[pkt.name] = new Highcharts.Chart({
                        chart: {
                            renderTo: escapeNonWords(pkt.name),
                            defaultSeriesType: 'spline',
                            valueDecimals: 2,
                            animation: false,
                        },
                        title: {
                            text: _.escape(pkt.name),
                        },
                        xAxis: {
                            labels: {
                                format: '{value:.2f}',
                            },
                        },
                        yAxis: {
                            title: {
                                text: 'Value',
                            },
                            labels: {
                                format: '{value:.2f}'
                            },
                        },
                        plotOptions: {
                            series: {
                                enableMouseTracking: true,
                                allowPointSelect: false,
                            },
                        },
                        series: [{
                            name: _.escape(pkt.name),
                            data: [pkt.value],
                        }],
                    });
                }
                $(function() {
                    $("#plots").sortable();
                    $("#plots").disableSelection();
                });
            });
        </script>
    </body>
</html>
